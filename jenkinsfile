pipeline {
    agent any

    environment {
        AZURE_CREDENTIALS = credentials('azurecredentials')
        AZ_TENANT_ID = '4f7d0492-1764-4824-8f60-f15e6d51cd70'
        ACR_NAME = 'TravelWebApp'
        ACR_LOGIN_SERVER = "travelwebapp.azurecr.io"
        IMAGE_NAME = "travelapp-image"
    }

    stages {
        stage('Checkout Code') {
            steps {
                deleteDir()
                git url: 'https://github.com/MadhawaRathnayake/MERN---RenukaTravels-Tours.git', branch: 'main'
            }
        }

        stage('Login to ACR') {
            steps {
                script {
                    sh '''
                        az login --service-principal -u $AZURE_CREDENTIALS_USR -p $AZURE_CREDENTIALS_PSW --tenant $AZ_TENANT_ID
                        az acr login -n $ACR_NAME
                        
                        ACR_USER=$(az acr credential show -n $ACR_NAME --query "username" -o tsv)
                        ACR_PWD=$(az acr credential show -n $ACR_NAME --query "passwords[0].value" -o tsv)
                        docker login $ACR_LOGIN_SERVER -u $ACR_USER -p $ACR_PWD
                    '''
                }
            }
        }

        stage('Build and Push Docker Image') {
            steps {
                script {
                    sh '''
                        docker build -t $ACR_LOGIN_SERVER/$IMAGE_NAME:latest .
                        docker push $ACR_LOGIN_SERVER/$IMAGE_NAME:latest
                    '''
                }
            }
        }
    }

    post {
        success {
            echo 'Docker image built and pushed to ACR successfully.'
        }
        failure {
            echo 'Pipeline failed. Check the console output for errors.'
        }
    }
}
